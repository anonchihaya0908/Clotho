/**
 * Bootstrap Module
 * ================
 *
 * This module is responsible for setting up and initializing all services
 * and their dependencies in the correct order. It acts as the central place
 * where the Dependency Injection (DI) container is configured.
 */

import * as vscode from 'vscode';
import { ServiceContainer } from './common/service-container';
import { PairCoordinator, PairCreatorService, PairCreatorUI } from './create-source-header-pair';
import { PairingRuleService, PairingRuleUI, PairingRuleCoordinator } from './pairing-rule-manager';
import { SwitchCoordinator, SwitchService, SwitchUI } from './switch-header-source';
import { MonitorCoordinator } from './clangd-monitor';
// ‰ΩøÁî®ÈáçÊûÑÂêéÁöÑÂçèË∞ÉÂô®
import { ClangFormatEditorCoordinator } from './visual-editor/clang-format/coordinator';
import { ClangFormatGuideService } from './visual-editor/clang-format/guide-service';
// import * as ClangFormatModule from './visual-editor/clang-format'; // Êú™‰ΩøÁî®ÔºåÂ∑≤Ê≥®Èáä
import { ClangFormatPreviewProvider } from './visual-editor/clang-format/preview-provider';
import { COMMANDS } from './common/constants';

export let serviceContainer: ServiceContainer;

/**
 * Bootstrap the entire extension.
 * This function is called once when the extension is activated.
 * It registers all service factories and initializes the main coordinators.
 *
 * @param context The VS Code extension context
 */
export async function bootstrap(context: vscode.ExtensionContext): Promise<void> {
    // Initialize the service container
    serviceContainer = new ServiceContainer();

    // Register all services in the container
    registerServices(context);

    // ÊøÄÊ¥ª Clang-Format ÂèØËßÜÂåñÁºñËæëÂô®Ê®°ÂùóÔºàÊ≥®ÂÜåËôöÊãüÊñáÊ°£Êèê‰æõËÄÖÔºâ
    try {
        ClangFormatPreviewProvider.register(context);
        console.log('Clotho: Successfully registered ClangFormatPreviewProvider');
    } catch (error) {
        console.error('Clotho: Failed to register ClangFormatPreviewProvider', error);
        // ‰∏çÊäõÂá∫ÈîôËØØÔºåÂÖÅËÆ∏Êâ©Â±ïÁªßÁª≠ËøêË°å
    }

    // Initialize main coordinators
    await initializeCoordinators();

    // Ê≥®ÂÜåÂëΩ‰ª§ÔºöÊâìÂºÄClang-FormatÁºñËæëÂô®
    context.subscriptions.push(
        vscode.commands.registerCommand(COMMANDS.OPEN_CLANG_FORMAT_EDITOR, async () => {
            try {
                const coordinator = serviceContainer.get('clangFormatVisualEditorCoordinator');
                await coordinator.showEditor();
            } catch (error) {
                console.error('Failed to open Clang-Format editor:', error);
                vscode.window.showErrorMessage('Failed to open Clang-Format editor. See console for details.');
            }
        })
    );

    // Register the service container for cleanup
    context.subscriptions.push({
        dispose: () => cleanup()
    });
}

/**
 * Register all service factories in the container.
 * Each service is registered with a factory function that defines how to create it.
 * Dependencies are resolved by calling `container.get()` for the required services.
 */
function registerServices(context: vscode.ExtensionContext): void {
    // Pairing Rule Manager
    serviceContainer.register('pairingRuleService', () => new PairingRuleService());
    serviceContainer.register('pairingRuleUI', (container) =>
        new PairingRuleUI(container.get('pairingRuleService')));
    serviceContainer.register('pairingRuleCoordinator', (container) =>
        new PairingRuleCoordinator(
            container.get('pairingRuleService'),
            container.get('pairingRuleUI')
        ));

    // Create Source/Header Pair
    serviceContainer.register('pairCreatorService', (container) =>
        new PairCreatorService(container.get('pairingRuleService')));
    serviceContainer.register('pairCreatorUI', (container) =>
        new PairCreatorUI(
            container.get('pairCreatorService'),
            container.get('pairingRuleService'),
            container.get('pairingRuleUI')
        ));
    serviceContainer.register('pairCoordinator', (container) =>
        new PairCoordinator(
            container.get('pairCreatorService'),
            container.get('pairCreatorUI')
        ));

    // Switch Header/Source
    serviceContainer.register('switchService', () => new SwitchService());
    serviceContainer.register('switchUI', () => new SwitchUI());
    serviceContainer.register('switchCoordinator', (container) =>
        new SwitchCoordinator(
            container.get('switchService'),
            container.get('switchUI')
        ));

    // Clangd Monitor - pass configuration from VS Code settings
    serviceContainer.register('monitorCoordinator', () => {
        const config = vscode.workspace.getConfiguration('clotho.clangdMonitor');
        return new MonitorCoordinator({
            memory: {
                updateInterval: config.get<number>('updateInterval', 5000),
                warningThreshold: config.get<number>('warningThreshold', 2048), // 2GB (yellow)
                errorThreshold: config.get<number>('errorThreshold', 4096) // 4GB (red)
            },
            cpu: {
                updateInterval: config.get<number>('updateInterval', 3000),
                warningThreshold: config.get<number>('cpuWarningThreshold', 50), // 50% (yellow)
                errorThreshold: config.get<number>('cpuErrorThreshold', 80), // 80% (red)
                normalizeCpu: true,
                showRawCpuInTooltip: true
            }
        });
    });

    // Clang-Format Visual Editor - ‰ΩøÁî®ÈáçÊûÑÂêéÁöÑÂçèË∞ÉÂô®
    serviceContainer.register('clangFormatVisualEditorCoordinator', () =>
        new ClangFormatEditorCoordinator(context.extensionUri)
    );

    // Êñ∞Â¢ûÔºöÂ§öÂÆû‰æãÂçèË∞ÉÂô®ÔºàÂèØÈÄâÔºâ
    try {
        const { MultiInstanceClangFormatCoordinator } = require('./visual-editor/clang-format/core/multi-instance-coordinator');
        serviceContainer.register('multiInstanceClangFormatCoordinator', () =>
            new MultiInstanceClangFormatCoordinator(context.extensionUri)
        );
    } catch (error) {
        console.warn('MultiInstanceClangFormatCoordinator not available:', error);
    }

    // Êñ∞Â¢ûÔºöÈò≤ÊäñÈõÜÊàêÊµãËØïÔºàÂèØÈÄâÔºâ
    try {
        const { DebounceIntegration } = require('./visual-editor/clang-format/core/debounce-integration');
        serviceContainer.register('debounceIntegration', () =>
            new DebounceIntegration(context.extensionUri)
        );
    } catch (error) {
        console.warn('DebounceIntegration not available:', error);
    }

    // Clang-Format Guide Service
    serviceContainer.register('clangFormatGuideService', () =>
        new ClangFormatGuideService()
    );
}

/**
 * Initialize the main coordinators.
 * These coordinators register commands and manage the lifecycle of their respective features.
 * The coordinators automatically register commands in their constructors.
 */
async function initializeCoordinators(): Promise<void> {
    // Initialize coordinators that only register commands
    serviceContainer.get('pairingRuleCoordinator');
    serviceContainer.get('pairCoordinator');
    serviceContainer.get('switchCoordinator');
    serviceContainer.get('clangFormatGuideService');

    // Ê≥®ÂÜåÈò≤ÊäñÊµãËØïÂëΩ‰ª§ÔºàÂ¶ÇÊûúÂèØÁî®Ôºâ
    if (serviceContainer.has('debounceIntegration')) {
        const debounceIntegration = serviceContainer.get('debounceIntegration');
        vscode.commands.registerCommand('clotho.testDebounce', async () => {
            try {
                console.log('üß™ Starting debounce test...');

                // ÂàõÂª∫ÊµãËØïÁî®ÁöÑÈò≤ÊäñÂ§ÑÁêÜÂô®
                const testHandler = debounceIntegration.createDebouncedPreviewCloseHandler(async () => {
                    console.log('üìÑ Original handler would be called here');
                });

                // Ê®°ÊãüÂø´ÈÄüË∞ÉÁî®
                console.log('‚ö° Simulating rapid calls...');
                testHandler();
                testHandler();
                testHandler();

                // ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ
                const stats = debounceIntegration.getStats();
                console.log('üìä Debounce stats:', stats);

                vscode.window.showInformationMessage(
                    `Debounce test completed! Check console for details. Active timers: ${stats.debounceManager.activeTimers.length}`
                );

            } catch (error) {
                console.error('‚ùå Debounce test failed:', error);
                vscode.window.showErrorMessage(`Debounce test failed: ${error}`);
            }
        });
    }

    // Ê≥®ÂÜåÊâãÂä®ÊµãËØïÂëΩ‰ª§
    vscode.commands.registerCommand('clotho.testDebounceManual', async () => {
        const { runManualDebounceTest } = require('./test/manual-debounce-test');
        await runManualDebounceTest();
    });

    vscode.commands.registerCommand('clotho.testRapidSwitching', async () => {
        const { testRapidSwitching } = require('./test/manual-debounce-test');
        await testRapidSwitching();
    });

    // Ê≥®ÂÜåÂç†‰ΩçÁ¨¶ÊµãËØïÂëΩ‰ª§
    vscode.commands.registerCommand('clotho.testPlaceholder', async () => {
        const { runAllPlaceholderTests } = require('./visual-editor/clang-format/test/placeholder-test');
        await runAllPlaceholderTests();
    });

    vscode.commands.registerCommand('clotho.testPlaceholderBasic', async () => {
        const { testPlaceholderBasicFunctionality } = require('./visual-editor/clang-format/test/placeholder-test');
        await testPlaceholderBasicFunctionality();
    });

    vscode.commands.registerCommand('clotho.testMainEditorClose', async () => {
        const { testMainEditorCloseLogic } = require('./visual-editor/clang-format/test/placeholder-test');
        await testMainEditorCloseLogic();
    });

    vscode.commands.registerCommand('clotho.testPreviewClose', async () => {
        const { testPreviewCloseLogic } = require('./visual-editor/clang-format/test/placeholder-test');
        await testPreviewCloseLogic();
    });

    vscode.commands.registerCommand('clotho.testDirectPlaceholder', async () => {
        const { testDirectPlaceholderCreation } = require('./visual-editor/clang-format/test/placeholder-test');
        await testDirectPlaceholderCreation();
    });

    // Ë∞ÉËØïÂëΩ‰ª§ÔºöÂº∫Âà∂ÂàõÂª∫Âç†‰ΩçÁ¨¶
    vscode.commands.registerCommand('clotho.forceCreatePlaceholder', async () => {
        try {
            console.log('üî• Force creating placeholder via debug command...');

            // Ëé∑ÂèñÂçèË∞ÉÂô®ÂÆû‰æã
            const coordinator = serviceContainer.get('clangFormatVisualEditorCoordinator');

            // ÈÄöËøáÂèçÂ∞ÑËÆøÈóÆÁßÅÊúâÊàêÂëòÔºà‰ªÖÁî®‰∫éË∞ÉËØïÔºâ
            const placeholderManager = (coordinator as any).placeholderManager;

            if (placeholderManager && typeof placeholderManager.forceCreatePlaceholder === 'function') {
                await placeholderManager.forceCreatePlaceholder();
                vscode.window.showInformationMessage('Âº∫Âà∂ÂàõÂª∫Âç†‰ΩçÁ¨¶ÂÆåÊàêÔºÅÊ£ÄÊü•Âè≥‰æßÊòØÂê¶Âá∫Áé∞Âç†‰ΩçÁ¨¶„ÄÇ');
            } else {
                vscode.window.showErrorMessage('Êó†Ê≥ïËÆøÈóÆÂç†‰ΩçÁ¨¶ÁÆ°ÁêÜÂô®');
            }
        } catch (error) {
            console.error('Force create placeholder failed:', error);
            vscode.window.showErrorMessage(`Âº∫Âà∂ÂàõÂª∫Âç†‰ΩçÁ¨¶Â§±Ë¥•: ${error}`);
        }
    });

    // Initialize and start the monitor coordinator
    const monitorCoordinator = serviceContainer.get('monitorCoordinator');

    // Check if clangd monitoring is enabled in configuration
    const config = vscode.workspace.getConfiguration('clotho.clangdMonitor');
    const isMonitoringEnabled = config.get<boolean>('enabled', true);

    if (isMonitoringEnabled) {
        try {
            await monitorCoordinator.startMonitoring();
            console.log('Clotho: Clangd monitoring started successfully');
        } catch (error) {
            console.error('Clotho: Failed to start clangd monitoring:', error);
        }
    } else {
        console.log('Clotho: Clangd monitoring is disabled in configuration');
    }
}

/**
 * Clean up all services when the extension is deactivated.
 */
export function cleanup(): void {
    if (serviceContainer) {
        serviceContainer.dispose();
    }
}
// Ë∞ÉËØïÂëΩ‰ª§ÔºöÊ£ÄÊü•ÁºñËæëÂô®ÁªÑÁä∂ÊÄÅ
vscode.commands.registerCommand('clotho.checkEditorGroups', async () => {
    const { checkEditorGroupsStatus } = require('./visual-editor/clang-format/test/placeholder-test');
    await checkEditorGroupsStatus();
});
// Ë∞ÉËØïÂëΩ‰ª§ÔºöÊµãËØïÂç†‰ΩçÁ¨¶ÂíåÈ¢ÑËßàÂàáÊç¢
vscode.commands.registerCommand('clotho.testPlaceholderSwitching', async () => {
    const { testPlaceholderPreviewSwitching } = require('./visual-editor/clang-format/test/placeholder-test');
    await testPlaceholderPreviewSwitching();
});