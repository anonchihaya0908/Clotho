# 代码质量优化实现计划

- [x] 1. 修复类型重复定义和创建统一类型系统

  - 创建统一的类型定义文件结构
  - 修复VALIDATION_ERROR重复定义问题
  - 建立类型导出入口文件
  - _需求: 1.1, 1.2, 1.3_

- [x] 1.1 创建统一类型定义文件结构


  - 创建 `src/common/types/` 目录和子文件
  - 实现 `webview.ts`, `config.ts`, `validation.ts` 类型文件
  - 创建类型导出入口 `src/common/types/index.ts`
  - _需求: 1.1_



- [ ] 1.2 修复VALIDATION_ERROR重复定义
  - 移除 `src/visual-editor/clang-format/types.ts` 中的重复定义
  - 将验证相关类型迁移到 `src/common/types/validation.ts`


  - 更新所有引用该类型的文件
  - _需求: 1.1_


- [ ] 1.3 重构WebviewMessageType枚举
  - 将WebviewMessageType移动到统一类型文件
  - 确保所有消息类型定义清晰且无重复
  - 更新所有使用该枚举的代码
  - _需求: 1.1_



- [ ] 2. 创建实例管理系统
  - 实现通用实例管理器接口
  - 创建ClangFormat专用实例管理器
  - 实现面板管理器
  - _需求: 2.1, 2.2, 2.3_



- [ ] 2.1 实现通用实例管理器
  - 创建 `src/common/services/instance-manager.ts`
  - 实现InstanceManager接口和基础实现类


  - 添加实例生命周期管理功能
  - 编写实例管理器的单元测试
  - _需求: 2.1, 2.2_


- [ ] 2.2 创建ClangFormat专用实例管理器
  - 实现 `ClangFormatInstanceManager` 类
  - 创建 `ClangFormatEditorInstance` 接口和实现
  - 实现实例状态管理和持久化
  - _需求: 2.1, 2.2_




- [ ] 2.3 实现面板管理器
  - 创建 `src/visual-editor/clang-format/ui/panel-manager.ts`


  - 实现PanelManager接口支持多面板管理
  - 添加面板焦点和可见性管理
  - _需求: 2.1, 2.2_


- [ ] 3. 重构Coordinator支持多实例
  - 移除单例限制逻辑
  - 重构面板创建和管理逻辑
  - 更新消息处理支持实例标识
  - _需求: 2.1, 2.2, 2.3_

- [ ] 3.1 移除Coordinator中的单例限制
  - 修改 `ClangFormatVisualEditorCoordinator` 移除单例模式
  - 更新面板存在性检查逻辑，支持多实例创建
  - 重构面板reveal逻辑，改为创建新实例
  - _需求: 2.1, 2.2_

- [ ] 3.2 重构面板创建和生命周期管理
  - 使用PanelManager管理面板创建和销毁
  - 实现实例ID生成和管理机制
  - 更新面板dispose逻辑支持实例清理
  - _需求: 2.2, 2.3_

- [ ] 3.3 更新消息处理支持实例隔离
  - 为WebviewMessage添加instanceId字段
  - 修改消息路由逻辑支持实例级处理
  - 确保预览编辑器与对应实例正确关联
  - _需求: 2.2, 2.3_

- [ ] 4. 重构文件结构和模块化
  - 创建新的目录结构
  - 拆分大文件为小模块
  - 重新组织导入导出关系
  - _需求: 3.1, 3.2, 3.3, 3.4_



- [ ] 4.1 创建新的common目录结构
  - 创建 `src/common/utils/`, `src/common/constants/` 目录
  - 实现工具函数模块 `file.ts`, `format.ts`, `validation.ts`
  - 创建常量定义模块 `commands.ts`, `messages.ts`, `ui.ts`
  - 建立统一的导出入口文件


  - _需求: 3.2, 3.3_

- [ ] 4.2 重构visual-editor目录结构
  - 创建 `core/`, `ui/`, `config/` 子目录

  - 将相关文件移动到对应目录
  - 更新文件间的导入路径
  - _需求: 3.1, 3.4_

- [x] 4.3 拆分coordinator.ts大文件

  - 将消息处理逻辑提取到 `ui/webview-handler.ts`
  - 将配置管理逻辑移动到 `config/` 目录
  - 保持coordinator作为协调器，减少直接业务逻辑
  - _需求: 3.1, 3.4_

- [ ] 5. 统一错误处理机制
  - 重构ErrorHandler支持实例级错误处理
  - 创建实例级错误处理器
  - 更新所有错误处理调用
  - _需求: 1.2, 4.2, 4.3, 4.4_

- [ ] 5.1 增强ErrorHandler支持实例上下文
  - 修改ErrorContext接口添加instanceId字段
  - 更新ErrorHandler.handle方法支持实例级错误
  - 实现错误消息的实例级路由
  - _需求: 4.2, 4.3_

- [ ] 5.2 创建实例级错误处理器
  - 实现 `InstanceErrorHandler` 类
  - 为每个编辑器实例创建专用错误处理器
  - 实现错误恢复和用户通知机制
  - _需求: 4.2, 4.3_

- [ ] 5.3 更新所有模块的错误处理调用
  - 替换format-service.ts中的错误处理调用
  - 更新coordinator.ts中的错误处理逻辑
  - 确保所有异步操作都有适当的错误处理
  - _需求: 4.2, 4.3, 4.4_

- [ ] 6. 性能优化和内存管理
  - 优化实例创建和销毁性能
  - 实现内存泄漏检测和预防
  - 添加性能监控和日志
  - _需求: 4.1, 4.3, 4.4_

- [ ] 6.1 优化实例生命周期管理
  - 实现延迟初始化减少启动开销
  - 添加实例池复用机制（可选）
  - 优化面板和预览编辑器的创建时机
  - _需求: 4.1, 4.3_

- [ ] 6.2 实现内存泄漏预防机制
  - 添加实例dispose时的资源清理检查
  - 实现事件监听器的自动清理
  - 添加定时器和异步操作的清理逻辑
  - _需求: 4.3, 4.4_

- [ ] 6.3 添加性能监控和诊断
  - 实现实例创建和销毁的性能日志
  - 添加内存使用情况监控
  - 创建性能诊断命令供开发调试使用
  - _需求: 4.1, 4.4_

- [ ] 7. 更新服务容器和依赖注入
  - 更新ServiceContainer支持多实例服务
  - 重构bootstrap.ts的服务注册逻辑
  - 确保服务依赖关系正确
  - _需求: 1.3, 2.1, 2.2_

- [ ] 7.1 增强ServiceContainer支持实例级服务
  - 修改ServiceContainer支持实例级服务注册
  - 实现服务作用域管理（全局/实例级）
  - 添加服务依赖解析的实例上下文
  - _需求: 2.1, 2.2_

- [ ] 7.2 重构bootstrap.ts服务注册
  - 更新服务注册逻辑支持新的实例管理器
  - 注册面板管理器和实例管理器服务
  - 确保服务初始化顺序正确
  - _需求: 1.3, 2.1_

- [ ] 8. 测试和验证
  - 编写单元测试覆盖新功能
  - 进行集成测试验证多实例功能
  - 性能测试确保优化效果
  - _需求: 1.1, 2.1, 2.2, 4.1_

- [ ] 8.1 编写核心功能单元测试
  - 为实例管理器编写完整的单元测试
  - 测试类型定义的正确性和完整性
  - 验证错误处理机制的各种场景
  - _需求: 1.1, 2.1, 4.2_

- [ ] 8.2 进行多实例集成测试
  - 测试同时创建多个编辑器实例
  - 验证实例间的状态隔离
  - 测试实例销毁时的资源清理
  - _需求: 2.1, 2.2, 2.3_

- [ ] 8.3 性能和稳定性测试
  - 进行长时间运行测试检查内存泄漏
  - 测试大量实例创建销毁的性能表现
  - 验证错误恢复机制的有效性
  - _需求: 4.1, 4.3, 4.4_