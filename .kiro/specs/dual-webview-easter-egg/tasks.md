# 双Webview动漫角色彩蛋实现计划

- [ ] 1. 创建基础双Webview架构
  - 实现双webview管理器核心逻辑
  - 建立左右面板的协调机制
  - 处理webview生命周期管理
  - _需求: 1.1, 1.2, 4.3_

- [ ] 1.1 实现双Webview管理器
  - 创建 `DualWebviewManager` 类管理左右面板
  - 实现webview创建、销毁和状态跟踪
  - 建立面板间的通信机制
  - 编写双webview管理器的单元测试
  - _需求: 1.1, 1.2_

- [ ] 1.2 建立预览文档关闭监听机制
  - 监听 `onDidCloseTextDocument` 事件
  - 识别预览文档关闭事件
  - 触发彩蛋webview创建流程
  - 处理快速切换的边界情况
  - _需求: 1.1, 4.3_

- [ ] 1.3 实现webview布局管理
  - 确保左右webview保持固定比例
  - 处理VSCode编辑器组的布局变化
  - 实现webview位置和大小的精确控制
  - _需求: 1.2_

- [x] 1.4 实现防抖和稳定性机制


  - 创建防抖管理器处理快速操作
  - 实现操作锁机制防止并发冲突
  - 建立快速占位符创建机制
  - 优化webview切换的时序控制
  - _需求: 5.1, 5.2, 5.3, 5.4_

- [ ] 2. 实现角色资源管理系统
  - 扫描和加载动漫角色图片
  - 建立角色信息数据库
  - 实现图片资源的优化和缓存
  - _需求: 2.1, 2.2, 4.1_



- [ ] 2.1 创建角色资源管理器
  - 实现 `CharacterResourceManager` 类
  - 扫描指定文件夹中的图片文件
  - 生成角色信息和元数据
  - 实现随机角色选择算法
  - _需求: 2.1, 2.2_

- [ ] 2.2 实现图片资源处理
  - 图片格式验证和转换
  - 生成webview可用的资源URI
  - 实现图片压缩和优化
  - 建立图片缓存机制
  - _需求: 2.2, 4.1_

- [ ] 2.3 建立角色信息数据库
  - 设计角色信息的数据结构
  - 实现角色信息的持久化存储
  - 支持角色标签和分类系统
  - 实现角色信息的快速查询
  - _需求: 2.1, 2.2_

- [ ] 3. 开发彩蛋Webview界面
  - 设计和实现彩蛋webview的HTML/CSS/JS
  - 创建角色展示和交互界面


  - 实现动画效果和用户交互
  - _需求: 3.1, 3.2, 3.3_

- [ ] 3.1 创建彩蛋Webview控制器
  - 实现 `EasterEggWebviewController` 类
  - 处理彩蛋webview的创建和初始化
  - 管理角色显示和切换逻辑
  - 处理用户交互事件
  - _需求: 3.1, 3.3_

- [ ] 3.2 设计彩蛋界面HTML模板


  - 创建响应式的角色展示界面
  - 实现角色图片、名称和信息的布局
  - 添加"重新打开预览"和"换一个角色"按钮
  - 支持深色和浅色主题切换
  - _需求: 3.1, 3.3_

- [ ] 3.3 实现交互动画和效果
  - 角色图片的hover动画效果
  - 角色切换时的过渡动画
  - 按钮点击的视觉反馈
  - 加载状态的友好显示
  - _需求: 3.2, 3.3_

- [ ] 4. 实现消息通信系统
  - 建立webview间的消息通信协议
  - 处理用户操作的消息传递
  - 实现状态同步机制
  - _需求: 1.3, 3.3_

- [ ] 4.1 定义消息通信协议
  - 设计彩蛋webview的消息类型枚举
  - 定义消息数据结构和接口
  - 建立消息路由和处理机制
  - _需求: 1.3, 3.3_

- [ ] 4.2 实现webview消息处理
  - 处理"重新打开预览"消息
  - 处理"切换角色"消息
  - 处理角色hover和click事件
  - 实现错误消息的传递和处理
  - _需求: 1.3, 3.3_

- [ ] 4.3 建立状态同步机制
  - 同步左右webview的状态
  - 处理状态不一致的恢复
  - 实现状态变化的事件通知
  - _需求: 4.3_

- [ ] 5. 实现错误处理和边界情况
  - 处理图片加载失败的情况
  - 实现webview创建失败的回退机制
  - 处理快速操作的并发问题
  - _需求: 4.1, 4.2, 4.3_

- [ ] 5.1 实现资源加载错误处理
  - 处理图片文件不存在或损坏
  - 提供默认占位符内容
  - 实现优雅的错误提示
  - 建立错误恢复机制
  - _需求: 4.1, 4.2_

- [ ] 5.2 处理webview创建失败
  - 检测webview创建失败的情况
  - 回退到原有的预览关闭行为
  - 记录错误日志用于调试
  - 向用户提供友好的错误信息
  - _需求: 4.2_

- [ ] 5.3 处理并发操作和竞态条件
  - 防止快速切换导致的状态混乱
  - 实现操作队列和锁机制
  - 处理webview销毁时的清理工作
  - 确保资源的正确释放
  - _需求: 4.3_

- [ ] 6. 性能优化和内存管理
  - 实现图片资源的懒加载
  - 优化webview内存使用
  - 建立资源清理机制
  - _需求: 2.2, 4.1_

- [ ] 6.1 实现懒加载和缓存策略
  - 按需加载角色图片资源
  - 实现LRU缓存算法
  - 预加载常用角色资源
  - 定期清理过期缓存
  - _需求: 2.2_

- [ ] 6.2 优化webview内存使用
  - 监控webview内存占用
  - 及时释放不用的webview资源
  - 优化HTML/CSS/JS的大小
  - 实现内存压力下的自动清理
  - _需求: 4.1_

- [ ] 6.3 建立资源监控和清理机制
  - 跟踪所有创建的webview实例
  - 实现定时的资源清理任务
  - 监控扩展的整体内存使用
  - 提供资源使用情况的调试信息
  - _需求: 4.1_

- [-] 7. 集成到现有系统

  - 更新现有的coordinator使用双webview架构
  - 保持向后兼容性
  - 更新服务容器注册
  - _需求: 1.1, 1.2, 1.3_

- [x] 7.1 重构现有coordinator


  - 修改 `ClangFormatVisualEditorCoordinator` 使用双webview管理器
  - 保持现有API的兼容性
  - 更新预览文档的创建和管理逻辑
  - _需求: 1.1, 1.2_

- [ ] 7.2 更新服务容器和依赖注入
  - 注册双webview相关的服务
  - 更新bootstrap.ts的服务配置
  - 确保服务依赖关系正确
  - _需求: 1.1_

- [ ] 7.3 更新扩展配置和命令
  - 添加彩蛋相关的配置选项
  - 更新package.json的命令定义
  - 确保扩展激活逻辑正确
  - _需求: 1.3_

- [ ] 8. 测试和验证
  - 编写单元测试和集成测试
  - 进行用户体验测试
  - 性能和稳定性测试
  - _需求: 1.1, 2.1, 3.1, 4.1_

- [ ] 8.1 编写核心功能单元测试
  - 测试双webview管理器的各种场景
  - 测试角色资源管理器的功能
  - 测试消息通信的正确性
  - 验证错误处理机制的有效性
  - _需求: 1.1, 2.1, 4.1_

- [ ] 8.2 进行集成测试
  - 测试完整的模式切换流程
  - 测试多个实例的并发使用
  - 测试长时间使用的稳定性
  - 验证内存使用的合理性
  - _需求: 1.1, 2.1, 3.1_

- [ ] 8.3 用户体验和性能测试
  - 测试界面响应速度和流畅度
  - 验证动画效果的表现
  - 测试不同主题下的显示效果
  - 收集用户反馈并优化体验
  - _需求: 3.1, 3.2, 3.3_